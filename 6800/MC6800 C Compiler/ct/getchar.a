 text
* #
* 
* /*
* 
* #ifndef EOF
* #define EOF     -1
* #endif
* 
* int     fin     = 0;
 data
 global fin
fin fdb 0
 text
* int     _ibytes = 0;
 data
 global _ibytes
_ibytes fdb 0
 text
* char    _ibuf[512];
* char    *_ipos  = _ibuf;
 data
 global _ipos
_ipos fdb _ibuf
 text
* int     _ipeek;
* 
* _filbuf() {
 global _filbuf
_filbuf
 pshs y,u
 jmp 1f
2
* #ifdef FLUSH
*         _ipos = _ibuf;
 ldx #_ibuf
 stx _ipos
*         if ((_ibytes = read(fin, _ibuf, sizeof _ibuf)) <= 0)
 ldd #512
 pshs d
 ldd #_ibuf
 pshs d
 ldd fin
 pshs d
 jsr read
 leas 6,s
 std _ibytes
 lbgt _1
*                 return(EOF);
_2
 ldd #-1
 puls y,u,pc

*         --_ibytes;
_1
 ldd _ibytes
 addd #-1
 std _ibytes
* #ifdef STRIP
*         return(*_ipos++ & 0377);
 ldx _ipos
 leax 1,x
 stx _ipos
 ldb -1,x
 sex
 andb #255
 clra
 puls y,u,pc

* #endif
* }
1 ldd #-140
 jsr _stkcheck
 jmp 2b


* 
* getchar() {
 global getchar
getchar
 pshs y,u
 jmp 1f
2
* #ifdef STRIP
* #define getchar() (--_ibytes>=0?*_ipos++&0377:_filbuf())
* #endif
*         return(getchar());
 ldd _ibytes
 addd #-1
 std _ibytes
 lblt _3
_4
 ldx _ipos
 leax 1,x
 stx _ipos
 ldb -1,x
 sex
 andb #255
 clra
 jmp _5
_3
 jsr _filbuf
_5
 puls y,u,pc

* }
1 ldd #-134
 jsr _stkcheck
 jmp 2b


* 
* ungetchar(c) {
 global ungetcha
ungetcha
 pshs y,u
 jmp 1f
2
* #ifdef STRIP
* #define ungetchar(x) (_ipos>_ibuf?(_ibytes++,((*--_ipos=(x))&0377)):EOF)
* #endif
*         return(ungetchar(c));
 ldd #_ibuf
 cmpd _ipos
 lbhs _6
_7
 ldd _ibytes
 addd #1
 std _ibytes
 subd #1
 ldd 6,s
 ldx _ipos
 leax -1,x
 stx _ipos
 stb ,x
 sex
 andb #255
 clra
 ldd 
 jmp _8
_6
 ldd #-1
_8
 puls y,u,pc

* }
1 jmp 2b


* 
* peekchar() {
 global peekchar
peekchar
 pshs y,u
 jmp 1f
2
* #ifdef STRIP
* #define peekchar() (_ibytes>0?*_ipos&0377:((_ipeek=_filbuf())==EOF?EOF:(_ibytes++,(*--_ipos=_ipeek)&0377)))
* #endif
*         return(peekchar());
 ldd _ibytes
 lble _9
_10
 ldx _ipos
 leax -1,x
 stx _ipos
 ldb ,x
 sex
 andb #255
 clra
 jmp _11
_9
 jsr _filbuf
 std _ipeek
 cmpd #-1
 lbne _12
_13
 ldd #-1
 jmp _14

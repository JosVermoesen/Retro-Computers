 name Setjmp

 text

* setjmp(env)

 global _setjmp
_setjmp ldx 2,s get env
 stu 0,x
 sty 2,x
 ldd 0,s get pc (return address)
 std 6,x
 sts 4,x save stack pointer
 ldd 4,x
 subd #2
 std 4,x
 ldd #0 return 0
 rts

* longjmp(env, val)

 global _longjmp
_longjmp ldx 2,s get env
 ldu 0,x restore u
 ldy 2,x restore y
 ldd 4,s test val
 bne 1f if 0 - return 1
 ldd #1
1 lds 4,x reset stack
 jmp [6,x] return

 end

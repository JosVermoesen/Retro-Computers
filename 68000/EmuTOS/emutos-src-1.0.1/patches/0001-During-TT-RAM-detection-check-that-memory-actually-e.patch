From 22fdd73e3de27fdcdbd6db2fec132e45d3a12a29 Mon Sep 17 00:00:00 2001
From: czietz <czietz@gmx.net>
Date: Sun, 22 Jul 2018 20:14:33 +0100
Subject: [PATCH] During TT-RAM detection check that memory actually exists,
 i.e. can be written to and read from

---
 bios/memory2.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/bios/memory2.c b/bios/memory2.c
index 9db0abb0..47c3a7cf 100644
--- a/bios/memory2.c
+++ b/bios/memory2.c
@@ -18,6 +18,7 @@
 #include "tosvars.h"
 #include "kprint.h"
 #include "machine.h"
+#include "processor.h"
 #include "vectors.h"
 #ifdef MACHINE_AMIGA
 #include "amiga.h"
@@ -36,7 +37,7 @@ static ULONG detect_ttram_size(void)
     /* Fixed-size TT-RAM */
     return CONF_TTRAM_SIZE;
 #else
-    UBYTE *addr;
+    volatile UBYTE *addr;
 
     /* By design, TT-RAM is always in 32-bit address space */
     if (!IS_BUS32)
@@ -53,8 +54,16 @@ static ULONG detect_ttram_size(void)
     for (addr = TTRAM_START + 1024UL*1024 - 1;
         (long)addr > 0; addr += 1024UL*1024)
     {
+        /* First check for bus error, then try writing to memory and
+         * reading back. */
         if (!check_read_byte((long)addr))
             break;
+
+        *addr     = 0x12;
+        *(addr-1) = 0x34;
+        invalidate_data_cache(addr-1, 2);
+        if ((*addr != 0x12) || (*(addr-1) != 0x34))
+            break;
     }
 
     /* Valid TT-RAM stops at the beginning of current megabyte */
-- 
2.17.0.windows.1


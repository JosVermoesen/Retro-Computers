From 8e51bc1ff12f9615882dc08c9b3fe1e117f0fa06 Mon Sep 17 00:00:00 2001
From: Christian Zietz <czietz@gmx.net>
Date: Tue, 26 Dec 2017 11:23:53 +0000
Subject: [PATCH 1/3] Use inline asm for IDE access to remove intermediate data
 register usage.

---
 bios/ide.c | 16 ++++++++++++----
 1 file changed, 12 insertions(+), 4 deletions(-)

diff --git a/bios/ide.c b/bios/ide.c
index 16353c4..b87b6c3 100644
--- a/bios/ide.c
+++ b/bios/ide.c
@@ -148,9 +148,13 @@ struct IDE
 #if IDE_32BIT_XFER
 #define XFERWIDTH   ULONG
 #define xferswap(a) swpw2(a)
+#define ide_get_and_incr(src,dst) asm volatile("move.l (%1),(%0)+" : "=a"(dst): "a"(src), "0"(dst));
+#define ide_put_and_incr(src,dst) asm volatile("move.l (%0)+,(%1)" : "=a"(src): "a"(dst), "0"(src));
 #else
 #define XFERWIDTH   UWORD
 #define xferswap(a) swpw(a)
+#define ide_get_and_incr(src,dst) asm volatile("move.w (%1),(%0)+" : "=a"(dst): "a"(src), "0"(dst));
+#define ide_put_and_incr(src,dst) asm volatile("move.w (%0)+,(%1)" : "=a"(src): "a"(dst), "0"(src));
 #endif
 
 #if CONF_ATARI_HARDWARE
@@ -739,8 +743,10 @@ static void ide_get_data(volatile struct IDE *interface,UBYTE *buffer,ULONG buff
             *p++ = temp;
         }
     } else {
-        while (p < end)
-            *p++ = interface->data;
+        while (p < end) {
+            /* Note that the pointer p gets incremented implicitly. */
+            ide_get_and_incr(&(interface->data), p);
+        }
     }
 }
 
@@ -835,8 +841,10 @@ static void ide_put_data(volatile struct IDE *interface,UBYTE *buffer,ULONG buff
             interface->data = temp;
         }
     } else {
-        while (p < end)
-            interface->data = *p++;
+        while (p < end) {
+            /* Note that the pointer p gets incremented implicitly. */
+            ide_put_and_incr(p, &(interface->data));
+        }
     }
 }
 
-- 
2.8.2.windows.1


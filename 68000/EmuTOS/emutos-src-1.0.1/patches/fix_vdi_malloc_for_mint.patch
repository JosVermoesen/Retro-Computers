From 5c2ff9a5474e9e9deee0e735e95f9b6e832e6276 Mon Sep 17 00:00:00 2001
From: Christian Zietz <czietz@gmx.net>
Date: Mon, 4 Sep 2017 17:51:31 +0100
Subject: [PATCH] Make VDI memory allocation during v_opnvwk global so they can
 be accessed by VDI calls from another process

---
 vdi/vdi_control.c | 7 +++++--
 vdi/vdi_defs.h    | 4 +++-
 2 files changed, 8 insertions(+), 3 deletions(-)

diff --git a/vdi/vdi_control.c b/vdi/vdi_control.c
index a2894be..5013a03 100644
--- a/vdi/vdi_control.c
+++ b/vdi/vdi_control.c
@@ -322,8 +322,11 @@ void vdi_v_opnvwk(Vwk * vwk)
     WORD handle;
     Vwk *temp, *work_ptr;
 
-    /* Allocate the memory for a virtual workstation. */
-    vwk = (Vwk *)trap1(X_MALLOC, (LONG) (sizeof(Vwk)));
+    /* Allocate the memory for a virtual workstation using Mxalloc with the flag
+     * for a global allocation. This becomes important when running MiNT
+     * on a CPU with memory protection.
+     */
+    vwk = (Vwk *)trap1(X_MXALLOC, (LONG)(sizeof(Vwk)), (WORD)(X_MXGLOBAL));
     if (vwk == NULL) {
         CONTRL[6] = 0;  /* No memory available, exit */
         return;
diff --git a/vdi/vdi_defs.h b/vdi/vdi_defs.h
index 6523159..9271e37 100644
--- a/vdi/vdi_defs.h
+++ b/vdi/vdi_defs.h
@@ -18,9 +18,11 @@
 
 #define HAVE_BEZIER 0           /* switch on bezier capability */
 
-/* GEMDOS function numbers */
+/* GEMDOS function numbers and parameters */
 #define X_MALLOC 0x48
 #define X_MFREE 0x49
+#define X_MXALLOC 0x44
+#define X_MXGLOBAL (2<<4)
 
 
 /* different maximum settings */
-- 
2.8.2.windows.1


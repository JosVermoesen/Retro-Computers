0001   0000             ; ACIA loopback code
0002   0000             
0003   0000             ; Define the ACIA control and data register addresses
0004   0000             ACIA_CTRL   .EQU 80H  ; Control register address
0005   0000             ACIA_DATA   .EQU 81H  ; Data register address
0006   0000             
0007   0000             ; Define the initialization values
0008   0000             ACIA_RESET  .EQU 03H	; Master reset
0009   0000             ACIA_INIT   .EQU 15H	; Disable receive interrupt
0010   0000             						; Set RTS low and transmit interrupt disabled
0011   0000             						; 8 data bits
0012   0000             						; no parity
0013   0000             						; 1 stop bit;
0014   0000             						; /1 clock (115200 baud with 1.8432 MHz clock)
0015   0000             
0016   0000             ; Define the reset vector address
0017   0000             RESET_VECTOR .EQU 0000H
0018   0000             
0019   0000             ; Start of the program
0020   0000                         .ORG RESET_VECTOR
0021   0000 C3 03 00                JP START          ; Jump to the start of the program
0022   0003             
0023   0003             START:
0024   0003 F3          			DI                	; Disable interrupts
0025   0004 3E 03                   LD A, ACIA_RESET	; Load the reset value into register A
0026   0006 D3 80                   OUT (ACIA_CTRL), A	; Write to the control register to reset the ACIA
0027   0008             
0028   0008 3E 15                   LD A, ACIA_INIT   ; Load the initialization value into register A
0029   000A D3 80                   OUT (ACIA_CTRL), A ; Write to the control register to initialize the ACIA
0030   000C             
0031   000C             ; Loop forever to read and write characters
0032   000C             MAIN_LOOP:
0033   000C CD 1F 00                CALL READ_CHAR    ; Read a character
0034   000F CD 14 00                CALL WRITE_CHAR   ; Write the character that was read
0035   0012 18 F8                   JR MAIN_LOOP      ; Repeat the loop
0036   0014             
0037   0014             ; Routine to write a character to the ACIA
0038   0014             WRITE_CHAR:
0039   0014 F5                      PUSH AF           ; Preserve the A register
0040   0015             WAIT_TX_READY:
0041   0015 DB 80                   IN A, (ACIA_CTRL) ; Read the status register
0042   0017 CB 4F                   BIT 1, A          ; Check if the transmitter is ready
0043   0019 28 FA                   JR Z, WAIT_TX_READY ; Wait until the transmitter is ready
0044   001B F1                      POP AF            ; Restore the A register
0045   001C D3 81                   OUT (ACIA_DATA), A ; Write the character in register A to the data register
0046   001E C9                      RET
0047   001F             ; Routine to read a character from the ACIA
0048   001F             READ_CHAR:
0049   001F             WAIT_RX_READY:
0050   001F DB 80                   IN A, (ACIA_CTRL) ; Read the status register
0051   0021 CB 47                   BIT 0, A          ; Check if data is available
0052   0023 28 FA                   JR Z, WAIT_RX_READY ; Wait until data is available
0053   0025 DB 81                   IN A, (ACIA_DATA) ; Read the character from the data register
0054   0027 C9                      RET
0055   0028             
0056   0028             ; End of the program
0057   0028                         .END START
tasm: Number of errors = 0
